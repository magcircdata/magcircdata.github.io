<link rel="shortcut icon" href=""> 
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.0/themes/smoothness/jquery-ui.css">

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

<style type="text/css">
path:hover {
	fill-opacity: 0.9;
}
#tooltip {
	position: absolute;
	text-align: center;
	line-height:  1;
	font-weight: bold;
	padding: 10px;
	background: rgba(100, 100, 100, 0.8);
	border-radius: 2px;
	border: 1px solid grey;
	pointer-events: none;
}
#svg {
	text-align: center;	
}
#map-title {
	text-align: center;	
	color: rgba(50, 50, 50, 1);
}

.ui-slider, .ui-slider-handle {
  height:400px;
}
</style>

<script src="library/jquery.min.js"></script>
<script src="library/bootstrap.min.js"></script>
<script src="library/d3.v4.min.js"></script>
<script src="library/jquery-ui.js"></script>

<body>
	<h1 id="map-title"></h4>
	<div class="container">
		<div class="row">
	        <div class="col-sm-1" style="margin-top:100px;">
	    		<div id="slider"></div>
	    		<div id="slider-labels"></div>
	    	</div>
	        <div class="col-sm-11">
	        	<div id="tooltip"></div>
				<div id="svg"></div>
			</div>
		</div>
	</div>
</body>
<div id="selector-container" class="container" style="text-align: center">
	<div class="row">
		<div class="col-sm-1"></div>
		<div class="col-sm-2">
			<h4>Magazine</h4>
			<div id="mag-selector" style="display: inline-block"></div>
		</div>

		<div class="col-sm-2">
			<h4>Reporting Date</h4>
			<div id="mag-date-selector" style="display: inline-block"></div>
		</div>

		<div class="col-sm-2">
			<h4>Data Type</h4>
			<div id="mag-type-selector" style="display: inline-block">
				<select class="form-control mag-type-select">
					<option value="total">Total Circulation</option>			
					<option value="newsStand">Newsstand</option>
					<option value="mailSubs">Mail Subs</option>
				</select>
			</div>
		</div>

		<div class="col-sm-2">
			<h4>Proportion</h4>
			<div id="census-selector" style="display: inline-block">
				<select class="form-control census-select">
					<option value="stateRelative">State Relative</option>			
					<option value="census">Census Relative</option>
				</select>
			</div>
		</div>

		<div class="col-sm-2">
			<h4>Presentation</h4>
			<div id="presentation-selector" style="display: inline-block">
				<select class="form-control presentation-select" id="presentation-select">
					<option value="percentage">Percentages</option>
					<option value="raw">Raw Numbers</option>
				</select>
			</div>
		</div>
		<div class="col-sm-1"></div>
	</div>
</div>

<script src="static-data/us-states-data.js"></script>
<!-- <script src="circ_data.js"></script> -->

<script src="phpQuery.js"></script>
<script src="CensusData.js"></script>

<script type="text/javascript">
/*
Resources used:
Great tooltip css (didn't end up using this though)
http://bl.ocks.org/Caged/6476579

Geomap and states.json
http://bl.ocks.org/michellechandra/0b2ce4923dc9b5809922

Census data scraped from wikipedia
*/

//used to clean wikipedia census data
// var d = {}
// for (var i in stateCensusData) {
// 	var line = stateCensusData[i];
// 	var stateData = {};
// 	for (var year in line) {
// 		if (year != "Name") {
// 			stateData[year] = +line[year];
// 		}
// 	}
// 	var name = line["Name"];
// 	d[name] = stateData;
// }
// console.log(d);
// console.log(JSON.stringify(d))

var width = 960;
var height = 600;

var projection = d3.geoAlbersUsa()
			.translate([width/2, height/2]);

var path = d3.geoPath()
		.projection(projection);

var svg = d3.select("#svg")
	.append("svg")
	.attr("width", width)
	.attr("height", height);

var gMap = svg.append("g")
	.attr("width", width)
	.attr("height", height);

var gLegendScale = svg.append("g")
	.attr("width", width)
	.attr("height", height);

var toolTip = d3.select("#toolTip")
	.style("display", "None");
svg.on("mouseout", function() {
	toolTip.transition()
		.style("display", "None")
}).on("mouseover", function() {
	toolTip.transition()
		.style("display", "block")
})



var legendHeight = 25;
var legendCellWidth = 25;
gLegendScale.selectAll("rect")
	.data([0,0,0,0,0,0,0]) //rects for now
	.enter()
	.append("rect")
	.attr("x", function(d, i) {
		return width-legendCellWidth*8+i*legendCellWidth;
	})
	.attr("y", height - legendHeight*2)
	.attr("width", legendCellWidth)
	.attr("height", legendHeight)
	.attr("stroke", "#ffffff")
	.attr("stroke-width", 1)
	.attr("fill", "#ffffff");

gLegendScale.selectAll("text")
	.data([0,0,0,0,0,0,0]) //rects for now
	.enter()
	.append("text")
	.attr("x", function(d, i) {
		return width-legendCellWidth*8+i*legendCellWidth + (legendCellWidth/2);
	})
	.attr("y", height - legendHeight*0.8)
	.attr("font-size", "10px")
	.attr("fill", "#444444")
	// .style("font-family", "")
	.style("text-anchor", "middle")
	.style("alignment-baseline", "central");
	// .attr("stroke", "#ffffff")
	// .attr("stroke-width", 1)
	// .attr("fill", "#ff00ff");

var gLegendPercent = svg.append("g")
	.attr("width", width)
	.attr("height", height);

gLegendPercent.selectAll("text")
	.data([0])
	.enter()
	.append("text")
	.attr("x", function(d) {
		return width - 17;
	})
	.attr("y", height - legendHeight*0.8)
	.attr("font-size", "14px")
	.attr("fill", "#444444")
	.style("text-anchor", "middle")
	.style("alignment-baseline", "central")
	.text("%");



function separateData(data) {
	var stateD = {}; //magId:date:state:{mailSubs, singleCopies}
	for (var i = 0; i < data.length; i++) {
		var row = data[i];
		var magId = row.magazine_id;
		var date = row.sample_period_end_date;
		var sampleIssueDate = row.sample_issue_date;
		var state = row.State;
		var mailSubs = +row.num_mail_subscriptions;
		var singleCopies = +row.num_single_copy_sales;
		var totalCirc = mailSubs + singleCopies;

		var decadeDate = date.substring(0, 3) + "0"; //1927 goes to 1920
		var censusPop = 0;

		var mailSubsCensus = 0;
		var singleCopiesCensus = 0;
		var totalCircCensus = 0;
		if (state in stateCensusData) {
			censusPop = stateCensusData[state][decadeDate];
			mailSubsCensus = mailSubs / censusPop;
			singleCopiesCensus = singleCopies / censusPop;
			totalCircCensus = totalCirc / censusPop;
		}


		if (!(magId in stateD)) {
			stateD[magId] = {
				'sortedDates': []
			};
		}
		if (!(date in stateD[magId])) {
			stateD[magId][date] = {
				"totalMailSubs": 0, 
				"totalSingleCopies": 0,
				"totalTotalCirc": 0,
				"maxMailSubs": 0,
				"maxSingleCopies": 0,
				"maxTotalCirc": 0,
				"maxCensusMail": 0,
				"maxCensusSingle": 0,
				"maxCensusTotal": 0
			};
			stateD[magId].sortedDates.push(date);
		}
		if (!(state in stateD[magId][date])) {
			stateD[magId][date][state] = {};
		}

		stateD[magId][date][state] = {
			"mailSubs": mailSubs, 
			"singleCopies": singleCopies,
			"totalCirc": totalCirc,
			"sampleIssueDate": sampleIssueDate,
			"censusPop": censusPop,
			"mailSubsCensus": mailSubsCensus, //highest proportion of mailsubs/census of state
			"singleCopiesCensus": singleCopiesCensus,
			"totalCircCensus": totalCircCensus
		};

		/*
		Find the max while loading the data
		*/
		if (stateD[magId][date].maxSingleCopies < singleCopies) {
			stateD[magId][date].maxSingleCopies = singleCopies;
		}
		if (stateD[magId][date].maxMailSubs < mailSubs) {
			stateD[magId][date].maxMailSubs = mailSubs;
		}
		if (stateD[magId][date].maxTotalCirc < totalCirc) {
			stateD[magId][date].maxTotalCirc = totalCirc;
		}
		if (stateD[magId][date].maxCensusMail < mailSubsCensus) {
			stateD[magId][date].maxCensusMail = mailSubsCensus;
		}
		if (stateD[magId][date].maxCensusSingle < singleCopiesCensus) {
			stateD[magId][date].maxCensusSingle = singleCopiesCensus;
		}
		if (stateD[magId][date].maxCensusTotal < totalCircCensus) {
			stateD[magId][date].maxCensusTotal = totalCircCensus;
		}

		
		stateD[magId][date]["totalMailSubs"] += mailSubs;	
		stateD[magId][date]["totalSingleCopies"] += singleCopies;
		stateD[magId][date]["totalTotalCirc"] += totalCirc;
	}

	for (var magId in stateD) {
		stateD[magId].sortedDates.sort();
	}

	return stateD;
}


//proportion to census data or raw numbers
//raw numbers
//relative to other states (proportion)
//proportional to census data
	//raw number/census number for that state
var map = {
	"currMagId":1,
	"currDateId":"1931-06-30",
	"mapData":{}, //data for a certain mag and date, dict keys states
	"sortedDates":[],
	"dataType": "totalCirc", //either newstand/single or mailsub D83200
	"isCensus":false,
	"displayPercentage":true,
	scaleColor: d3.scaleLinear().range(["#FFED90", "#FF4D21"]),
	setData: function() { //sets data to the current mag id and date
		map.mapData = stateD[map.currMagId][map.currDateId];
		map.sortedDates = stateD[map.currMagId].sortedDates;
	},
	setInitialDate: function() {
		map.currDateId = map.sortedDates[0];
		map.setData();
	},
	setScaleColor: function() {
		var domainMax;
		if (map.dataType == "newsStand") {
			domainMax = map.isCensus ? map.mapData.maxCensusSingle : map.mapData.maxSingleCopies / map.mapData.totalSingleCopies;
		} else if (map.dataType == "mailSubs") {
			domainMax = map.isCensus ? map.mapData.maxCensusMail : map.mapData.maxMailSubs / map.mapData.totalMailSubs;
		} else {
			domainMax = map.isCensus ? map.mapData.maxCensusTotal : map.mapData.maxTotalCirc / map.mapData.totalTotalCirc;
		}
		map.scaleColor
			.domain([0, domainMax]);
	},
	updateMap: function() {
		geoMapPath
		.transition()
		.style("fill", function(d) {
			var state = d.properties.name;
			if (!(state in map.mapData)) {
				return "#000000";
			}
			var numToScale = 0;
			var mapStateData = map.mapData[state];
			if (map.dataType == "newsStand") {
				numToScale = map.isCensus ? mapStateData.singleCopiesCensus : map.mapData[state].singleCopies / 
					map.mapData.totalSingleCopies;
			} else if(map.dataType == "mailSubs") {
				numToScale = map.isCensus ? mapStateData.mailSubsCensus : map.mapData[state].mailSubs / 
					map.mapData.totalMailSubs
			}
			else {
				numToScale = map.isCensus ? mapStateData.totalCircCensus :map.mapData[state].totalCirc / 
					map.mapData.totalTotalCirc
			}
			return map.scaleColor(numToScale);
		})
	},
	updateLegendScale: function() {
		//no need to enter data
		var min = 0;
		var max;
		if (map.dataType == "newsStand") {
			max = map.isCensus ? map.mapData.maxCensusSingle : map.mapData.maxSingleCopies / map.mapData.totalSingleCopies;
		} else if (map.dataType == "mailSubs") {
			max = map.isCensus ? map.mapData.maxCensusMail : map.mapData.maxMailSubs / map.mapData.totalMailSubs;
		} else {
			max = map.isCensus ? map.mapData.maxCensusTotal : map.mapData.maxTotalCirc / map.mapData.totalTotalCirc;
		}
		if (max == Infinity) {
			max = 0;
		}
		/*
if (map.dataType == "newsStand") {
			if (map.isCensus) {
				max = map.mapData.maxCensusSingle
			} else {
				max = map.displayPercentage ? map.mapData.maxSingleCopies : map.mapData.maxSingleCopies / map.mapData.totalSingleCopies;
			}
		} else if (map.dataType == "mailSubs") {
			if (map.isCensus) {
				max = map.mapData.maxCensusMail
			} else {
				max = map.displayPercentage ? map.mapData.maxCensusMail : map.mapData.maxCensusMail / map.mapData.totalMailSubs;
			}
		} else {
			if (map.isCensus) {
				max = map.mapData.maxCensusTotal
			} else {
				max = map.displayPercentage ? map.mapData.maxTotalCirc : map.mapData.maxTotalCirc / map.mapData.totalTotalCirc;
			}
		}
		*/

		var diff = max - min;

		var legendQuantiles = [];
		for (var i = 0; i < 7; i++) {
				legendQuantiles.push(diff*i/6 + min);
		}

		var q2 = (min+max)/2;
		var q1 = (q2+min)/2;
		var q3 = (q2+max)/2;

		// var legendQuantiles = [min, q1, q2, q3, max];

		var legendData = [];

		for (var i = 0; i < legendQuantiles.length; i++) {
			legendData[i] = {
				quantile:legendQuantiles[i],
				color:map.scaleColor(legendQuantiles[i])
			};
		}

		gLegendScale.selectAll("rect")
			.data(legendData)
			.transition()
			.attr("fill", function(d){
				return d.color;
			});


		gLegendScale.selectAll("text")
			.data(legendData)
			.transition()
			.text(function(d){
				if (d.quantile*100 >= 10) {
					return d3.format(".1f")(d.quantile*100);
				}
				else {
					return d3.format(".2f")(d.quantile*100);
				}

				// return formatDec(d.quantile*100)+"%";
			})
	}
}

var geoMapPath = gMap.selectAll("path")
	.data(statesJson.features)
	.enter()
	.append("path")
	.attr("d", path)
	.style("stroke", "#fff")
	.style("stroke-width", 1)
	.style("fill", "#ffffff")
	.on("mouseover", function(d) {
		var mouseX = d3.event.pageX;
		var mouseY = d3.event.pageY;

		var stateName = d.properties.name;
		var magData = map.mapData[stateName];
		
		var magTitle = magIdMap[map.currMagId];
		var sampleIssueDate = magData.sampleIssueDate;
		var singleCopies = magData.singleCopies;
		var mailSubs = magData.mailSubs;
		var totalCirc = singleCopies + mailSubs;

		var maxTotalCirc = map.mapData.maxTotalCirc;
		var maxSingleCopies = map.mapData.maxSingleCopies;
		var maxMailSubs = map.mapData.maxMailSubs;

		var mailSubsCensus = magData.mailSubsCensus * 100;
		var singleCopiesCensus = magData.singleCopiesCensus * 100;
		var totalCircCensus = magData.totalCircCensus * 100;

		var format2Dec = d3.format(".2f");

		var innerHtml;

		if (map.isCensus) {
			innerHtml = "<tr><td>Total Circ:</td> <td align=center>"+format2Dec(totalCircCensus)+"%"+"</td> </tr>" +
			"<tr><td>Newsstand:</td> <td align=center>"+format2Dec(singleCopiesCensus)+"%"+"</td> </tr>" +
			"<tr><td>Mail Subs:</td> <td align=center>"+format2Dec(mailSubsCensus)+"%"+"</td> </tr>";
		} else {
			if (map.displayPercentage) {
				var totalProp = totalCirc/map.mapData.totalTotalCirc * 100;
				var singleProp = singleCopies/map.mapData.totalSingleCopies * 100;
				var mailProp = mailSubs/map.mapData.totalMailSubs * 100;

				if (isNaN(totalProp)) {totalProp = 0;}
				if (isNaN(singleProp)) {singleProp = 0;}
				if (isNaN(mailProp)) {mailProp = 0;}

				innerHtml = "<tr><td>Total Circ:</td> <td align=center>"+format2Dec(totalProp)+"%"+"</td> </tr>" +
				"<tr><td>Newsstand:</td> <td align=center>"+format2Dec(singleProp)+"%"+"</td> </tr>" +
				"<tr><td>Mail Subs:</td> <td align=center>"+format2Dec(mailProp)+"%"+"</td> </tr>";
			} else {
				innerHtml = "<tr><td>Total Circ:</td> <td align=center>"+totalCirc+"</td> </tr>" +
				"<tr><td>Newsstand:</td> <td align=center>"+singleCopies+"</td> </tr>" +
				"<tr><td>Mail Subs:</td> <td align=center>"+mailSubs+"</td> </tr>";
			}
		}

		toolTip
			.style("top", mouseY - 50 + "px")
			.style("left", mouseX - 400 + "px")
			.html(stateName + "\n" +
				magTitle + "\n" +
				sampleIssueDate + "\n" +
				singleCopies + "\n" +
				mailSubs + "\n" +
				totalCirc)
			.html( "<b style='align:center;'>"+stateName+"</b>" +

			"<table style='font-size:12px;' cellpadding=0 cellspacing=0>" +
				innerHtml +
			"</table>")
	});



function selectMag(magId) {
	map.currMagId = magId;

	map.setData()
	map.setInitialDate();
	map.setScaleColor()
	map.updateMap()
	map.updateLegendScale();
	$("#mag-date-selector").html(genDateSelection());
	var dates = map.sortedDates;
	updateSliderRange(dates.length - 1);
}

function selectDate(date) {
	map.currDateId = date;
	map.setData()
	map.setScaleColor()
	map.updateMap()
	map.updateLegendScale();
	updateTitle();
}

function selectMagType(magType) {
	map.dataType = magType;
	map.setScaleColor()
	map.updateMap()
	map.updateLegendScale();
	updateTitle();
}

function selectCensus(isCensus) {
	map.isCensus = isCensus == "census";

	if (map.isCensus) {
		$("#presentation-select").attr("disabled", "disabled");
	} else {
		$("#presentation-select").removeAttr("disabled", "disabled");		
	}

    map.setData()
	map.setScaleColor()
	map.updateMap()
	map.updateLegendScale();
}

function selectPresentation(presentation) {
	map.displayPercentage = presentation == "percentage";
	map.updateLegendScale();
}

function updateTitle() {
	var magName = magIdMap[map.currMagId]
	var magType = "Total Circulation";
	if (map.dataType == "newsStand") {
		magType = "Newsstand";
	} else if (map.dataType == "mailSubs") {
		magType = "Mail Subscription";
	}
	var magDate = map.currDateId;

	$("#map-title").html(
		magName + " " + magType + " Sales for " + magDate
		);
}

function onSliderChange(i) {
	var selectedDate = map.sortedDates[i];

	if (selectedDate == map.currDateId) {
		return;
	}
	selectDate(selectedDate);
}

function updateSliderRange(newMax) {
	$("#slider-labels").find("label").remove();

	$("#slider").slider("option", "max", newMax);
	var slider = $("#slider").slider("value", 0);


	slider.each(function() {
		var sliderParams = $(this).data().uiSlider.options;

		var max = sliderParams.max;
		var min = sliderParams.min;
		var step = sliderParams.step;

		var nVals = (max-min)/step;

		var sortedDates = map.sortedDates;
		for (var i = 0; i < nVals + 1; i++) {
			var ele = $('<label>' +sortedDates[i]+ '</label>')
				.css("top", 98 - (i/nVals*100) + "%")
				.css("left", "35%")
				.css("position", "absolute")
				.css("font-size", "10px");
				// .css("padding", "100px");
			$("#slider-labels").append(ele);
		}
	});

}


function genDateSelection() {
  var start = '<select class="form-control mag-date-select">';
  for (var i in map.sortedDates) {
  	var date = map.sortedDates[i];
  	start+="<option value='"+date+"'>"+date+"</option>";
  }
  var end = '</select>';
  return start+end;
}


var magIdMap = {};

var idMagMap = {};

$.when(dbQuery("magazines"), dbQuery("circ_data_by_loc_with_statenames")).done(function(csvMag, csvGeoCirc){

	

	var circData = d3.csvParse(csvGeoCirc[0], function(d){
		return d;
	});
	stateD = separateData(circData);

	d3.csvParse(csvMag[0], function(d){
		if (d.magazine_id in stateD) {
			magIdMap[d.magazine_id] = d.title;
			idMagMap[d.title] = d.magazine_id;
		}
	});

	$(document).ready(function(){
		//build the slider
		var slider = $("#slider").slider({
			orientation: 'vertical',
			value: 0,
			min: 0,
			max: 6, //set max to the number of dates you have - 1
			step: 1,
			slide: function(event, ui) {
				var index = ui.value;
				onSliderChange(index);
			}
		});

		selectMag("1"); //select default to be BlackMask
		map.updateMap();
		map.updateLegendScale();
		updateTitle();
		updateSliderRange(stateD[map.currMagId].sortedDates.length - 1);


		function genMagSelection() {
		  var start = '<select class="form-control mag-select">';
		  // start+='<option value="" hidden>Select a magazine</option>';
		  for (var id in magIdMap) {
		  	var magName = magIdMap[id];
		  	start+="<option value='"+magName+"'>"+magName+"</option>";
		  }
		  var end = '</select>';
		  return start+end;
		}
		$("#mag-selector").html(genMagSelection());

		
		$("#mag-date-selector").html(genDateSelection());

		$(document).on("change", ".mag-select", function(){ //on select magazine
		    var magName = $(this).children(":selected").val();
		    var magId = idMagMap[magName];
		    selectMag(magId);
			updateTitle();
		  });

		$(document).on("change", ".mag-date-select", function(){ //on select magazine
		    var date = $(this).children(":selected").val();
		    selectDate(date);
		  });

		$(document).on("change", ".mag-type-select", function(){ //on select magazine
		    var magType = $(this).children(":selected").val();
		    selectMagType(magType);
		  });

		$(document).on("change", ".census-select", function(){ //on select magazine
		    var isCensus = $(this).children(":selected").val();
		    selectCensus(isCensus);
		  });


		$(document).on("change", ".presentation-select", function(){ //on select magazine
		    var percentage = $(this).children(":selected").val();
		    selectPresentation(percentage);
		  });
	});

});


</script>